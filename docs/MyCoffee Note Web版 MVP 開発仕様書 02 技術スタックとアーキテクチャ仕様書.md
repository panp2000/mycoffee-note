# MyCoffee Note Web版 MVP 技術仕様書

## 2. 技術スタックとアーキテクチャ仕様書

### 2.1 技術スタック選定

#### フロントエンド
- **ビルドツール**: Vite
  - *選定理由*: 高速な開発サーバー、効率的なHMR、モダンなビルド最適化
  - *利点*: 開発体験の向上、ビルド時間の短縮

- **フレームワーク**: React 19 + TypeScript
  - *選定理由*: 最新の機能（React Server Components、並列処理の改善）、広範なエコシステム、型安全性
  - *利点*: パフォーマンスの向上、コンポーネントの再利用性、最新のReactパラダイム

- **UIライブラリ**: shadcn/ui (Radix UI + Tailwind CSS)
  - *選定理由*: 高品質コンポーネント、カスタマイズ性、アクセシビリティ対応
  - *利点*: 開発速度の向上、一貫したデザインシステム

- **状態管理**: Zustand
  - *選定理由*: シンプルなAPI、Reduxより少ないボイラープレート、Reactの最新機能との統合
  - *利点*: 学習曲線が緩やか、ボイラープレートコードの削減

- **フォーム管理**: React Hook Form + Zod
  - *選定理由*: パフォーマンス最適化、使いやすさ、バリデーション機能
  - *利点*: 効率的なフォーム実装、型安全なバリデーション

- **ルーティング**: TanStack Router
  - *選定理由*: タイプセーフ、データフェッチングとの統合、安定性
  - *利点*: 型安全なルーティング、将来のReact Native移行時の互換性検討

- **データフェッチング**: TanStack Query (React Query)
  - *選定理由*: キャッシュ管理、再フェッチポリシー、サーバー状態管理
  - *利点*: データの同期管理の簡素化、ローディング/エラー状態の一元管理

#### バックエンド
- **BaaS**: Supabase
  - *選定理由*: 認証、データベース、ストレージの統合ソリューション
  - *利点*: バックエンド開発の省力化、スケーラビリティ

- **データベース**: PostgreSQL (Supabase提供)
  - *選定理由*: 信頼性、SQLの柔軟性、JSONBによる半構造化データのサポート
  - *利点*: 堅牢なデータ保存、リレーショナルモデルとJSONの柔軟な組み合わせ

- **認証**: Supabase Auth
  - *選定理由*: メール認証とGoogle OAuth統合の容易さ
  - *利点*: セキュアな認証基盤、拡張可能なアクセス管理

- **ストレージ**: Supabase Storage
  - *選定理由*: 画像などのバイナリデータ保存、アクセス制御
  - *利点*: ファイル管理の簡素化、セキュリティルールによる保護

#### デプロイメント
- **MVPフェーズ推奨**: Vercel
  - *選定理由*: 迅速なデプロイ、CI/CD統合、プレビュー機能、無料枠の充実
  - *利点*: 開発速度の向上、デプロイメントの簡素化
  - *将来的考慮点*: 料金体系がトラフィック依存で成長時にコスト増加の可能性

- **将来的な代替オプション**:
  1. **AWS Amplify**:
     - *利点*: AWS統合、スケーラビリティ、細かいリソース制御
     - *考慮点*: 設定の複雑さ、学習曲線
     
  2. **Netlify**:
     - *利点*: Vercelに類似した使いやすさ、異なる料金体系
     - *考慮点*: 一部機能でVercelに劣る場合がある
     
  3. **カスタムホスティング (AWS/GCP/Azure)**:
     - *利点*: 完全な制御性、コスト最適化の可能性
     - *考慮点*: 設定と維持の複雑さ、DevOps知識の必要性

### 2.2 アーキテクチャ設計

#### 全体アーキテクチャ

```
┌─────────────────────────────────────────────────┐
│                  Client (Web Browser)            │
│                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────┐  │
│  │React Components│<─>│State Management│<─>│Cache│  │
│  └─────────────┘    └─────────────┘    └─────┘  │
│          ↑                 ↑                ↑    │
│          │                 │                │    │
│  ┌─────────────────────────────────────────────┐  │
│  │               React Query Layer              │  │
│  └─────────────────────────────────────────────┘  │
│          ↑                                      │
└──────────┼──────────────────────────────────────┘
           │
┌──────────┼──────────────────────────────────────┐
│ ┌────────▼───────────┐   ┌─────────────────────┐ │
│ │  Supabase Client    │<─>│ Authentication      │ │
│ └────────────────────┘   └─────────────────────┘ │
│          ↑                        ↑              │
└──────────┼────────────────────────┼──────────────┘
           │                        │
┌──────────┼────────────────────────┼──────────────┐
│ ┌────────▼───────────┐   ┌────────▼────────────┐ │
│ │  PostgreSQL DB      │   │  Supabase Auth      │ │
│ └────────────────────┘   └─────────────────────┘ │
│                                                 │
│ ┌────────────────────┐   ┌─────────────────────┐ │
│ │  Supabase Storage   │   │  Supabase Functions │ │
│ └────────────────────┘   └─────────────────────┘ │
│                                                 │
│                    Supabase                      │
└─────────────────────────────────────────────────┘
```

#### コンポーネント構成

```
src/
├── components/           # 再利用可能なUIコンポーネント
│   ├── ui/               # shadcn/uiコンポーネント
│   ├── common/           # アプリ共通コンポーネント
│   ├── recipe/           # レシピ関連コンポーネント
│   └── evaluation/       # 評価関連コンポーネント
├── pages/                # ページコンポーネント
│   ├── auth/             # 認証関連ページ
│   ├── recipes/          # レシピ関連ページ
│   └── settings/         # 設定ページ
├── hooks/                # カスタムフック
│   ├── api/              # API関連フック
│   ├── form/             # フォーム関連フック
│   └── auth/             # 認証関連フック
├── stores/               # Zustandストア
├── lib/                  # ユーティリティ・ヘルパー
│   ├── utils/            # 汎用ユーティリティ
│   ├── supabase/         # Supabase連携
│   └── validators/       # バリデーションスキーマ
├── types/                # TypeScript型定義
└── assets/               # 静的アセット
```

### 2.3 データフロー

#### 1. 認証フロー
- ユーザーがログインフォーム送信 → Supabase Auth API呼び出し → JWT生成 → クライアントストレージに保存 → 認証状態更新

#### 2. データ取得フロー
- コンポーネントマウント → React Queryフック呼び出し → キャッシュ確認 → 必要に応じてSupabase API呼び出し → 状態更新

#### 3. データ作成/更新フロー
- フォーム送信 → バリデーション → Supabase API呼び出し → 成功時DB更新 → React Queryキャッシュ更新 → UI更新

### 2.4 将来的な拡張性への考慮

#### モバイルアプリ展開への道筋
- フロントエンド層とデータ層の明確な分離
- ビジネスロジックの再利用可能な実装
- React NativeとWebの共通型定義

#### スケーラビリティの考慮
- RLS（Row Level Security）による効率的なアクセス制御
- 効率的なクエリ設計（インデックス最適化）
- Edge Functionsによるサーバレス処理の可能性

#### オフライン対応への方針
- IndexedDBによるローカルキャッシュ（将来的な実装）
- オンライン復帰時の同期戦略
- コンフリクト解決メカニズム

### 2.5 デプロイメント戦略

#### MVPフェーズ
- **ホスティング**: Vercel
  - 迅速なデプロイメント環境の構築
  - GitHubとの連携による自動デプロイ
  - 開発・ステージング・本番環境の分離

#### 拡張フェーズへの移行準備
- **環境変数の適切な管理**:
  - Vercel固有の環境変数形式への過度な依存を避ける
  - `.env`ファイルでの一元管理

- **Vercel固有機能の利用制限**:
  - Edge Functions/Middlewareの使用を最小限に
  - 移行容易なサーバレス関数設計

- **ビルド・デプロイプロセスの文書化**:
  - 他プラットフォームへの移行に備えたビルドプロセスの明確化
  - 依存関係と環境要件の詳細な記録

- **トラフィック・コスト監視**:
  - 定期的なトラフィックパターン分析
  - コスト予測と閾値設定（移行検討のトリガー）

#### 将来的な移行オプション（利用状況に応じて検討）
1. **中規模トラフィック（数千MAU）**: Netlify, Render, DigitalOcean App Platform
2. **大規模トラフィック（数万MAU以上）**: AWS (ECS/ECR + CloudFront), GCP (Cloud Run + CDN), Azure (App Service + CDN)
3. **特殊要件（地域制約/規制対応）**: 専用サーバー/VPSホスティング

### 2.6 セキュリティ考慮事項

#### 認証セキュリティ
- JWTベースの認証システム（Supabase Auth）
- セキュアなパスワードハッシュ（bcrypt）
- サードパーティ認証プロバイダー（Google）の安全な統合

#### データセキュリティ
- RLS（Row Level Security）によるデータアクセス制御
- ユーザーごとのデータ分離
- センシティブデータの暗号化

#### クライアントサイドセキュリティ
- XSS対策（React自動エスケープ）
- CSRF保護
- セキュアなローカルストレージ利用

#### コンプライアンス準備
- GDPR基本対応
- Cookie通知
- プライバシーポリシー